<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous" />
        <title>Basoro WhatsApp API</title>
        <link rel="icon" href="https://getbootstrap.com/docs/5.0/assets/img/favicons/favicon.ico" />
        <meta name="theme-color" content="#7952b3" />
        <style>
            html,
            body {
                height: 100%;
            }
            .form-signin {
                width: 100%;
                max-width: 330px;
                padding: 15px;
                margin: auto;
            }
            .form-signin .form-floating:focus-within {
                z-index: 2;
            }
            .form-signin input[type="email"] {
                margin-bottom: -1px;
                border-bottom-right-radius: 0;
                border-bottom-left-radius: 0;
            }
            .form-signin input[type="password"] {
                margin-bottom: 10px;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
            .form-signin .sender input[type="text"] {
                margin-bottom: -1px;
                border-bottom-right-radius: 0;
                border-bottom-left-radius: 0;
            }
            .form-signin .sender1 input[type="text"] {
                margin-bottom: -1px;
            }
            .form-signin .number input[type="text"] {
                margin-bottom: -1px;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
                border-bottom-left-radius: 0;
            }
            .form-signin .message input[type="text"] {
                margin-bottom: 10px;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
            .form-signin .sender2 input[type="text"] {
                margin-bottom: 10px;
            }
            .container {
                max-width: 960px;
            }
            .hide {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container py-3">
            <header class="d-flex flex-column flex-md-row align-items-center pb-3 mb-4 border-bottom">
                <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" class="me-2" viewBox="0 0 118 94" role="img">
                        <title>Basoro</title>
                        <path
                            fill-rule="evenodd"
                            clip-rule="evenodd"
                            d="M24.509 0c-6.733 0-11.715 5.893-11.492 12.284.214 6.14-.064 14.092-2.066 20.577C8.943 39.365 5.547 43.485 0 44.014v5.972c5.547.529 8.943 4.649 10.951 11.153 2.002 6.485 2.28 14.437 2.066 20.577C12.794 88.106 17.776 94 24.51 94H93.5c6.733 0 11.714-5.893 11.491-12.284-.214-6.14.064-14.092 2.066-20.577 2.009-6.504 5.396-10.624 10.943-11.153v-5.972c-5.547-.529-8.934-4.649-10.943-11.153-2.002-6.484-2.28-14.437-2.066-20.577C105.214 5.894 100.233 0 93.5 0H24.508zM80 57.863C80 66.663 73.436 72 62.543 72H44a2 2 0 01-2-2V24a2 2 0 012-2h18.437c9.083 0 15.044 4.92 15.044 12.474 0 5.302-4.01 10.049-9.119 10.88v.277C75.317 46.394 80 51.21 80 57.863zM60.521 28.34H49.948v14.934h8.905c6.884 0 10.68-2.772 10.68-7.727 0-4.643-3.264-7.207-9.012-7.207zM49.948 49.2v16.458H60.91c7.167 0 10.964-2.876 10.964-8.281 0-5.406-3.903-8.178-11.425-8.178H49.948z"
                            fill="currentColor"
                        ></path>
                    </svg>
                    <span class="fs-4">Basoro WA API</span>
                </a>
                <nav class="d-inline-flex mt-2 mt-md-0 ms-md-auto">
                    <ul class="nav nav-pills" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-user-tab" data-bs-toggle="pill" data-bs-target="#pills-user" type="button" role="tab" aria-controls="pills-user" aria-selected="true">User</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-auth-tab" data-bs-toggle="pill" data-bs-target="#pills-auth" type="button" role="tab" aria-controls="pills-auth" aria-selected="false">Auth</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-send-tab" data-bs-toggle="pill" data-bs-target="#pills-send" type="button" role="tab" aria-controls="pills-send" aria-selected="false">Send</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-media-tab" data-bs-toggle="pill" data-bs-target="#pills-media" type="button" role="tab" aria-controls="pills-media" aria-selected="false">Media</button>
                        </li>
                    </ul>
                </nav>
            </header>
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-user" role="tabpanel" aria-labelledby="pills-user-tab">
                    <div class="p-3 pb-md-4 mx-auto text-center">
                        <div class="form-signin">
                            <form id="sender1">
                                <h1 class="h3 mb-3 fw-normal text-center">User</h1>
                                <div class="form-floating sender1"><input type="text" class="form-control" id="client-id" placeholder="ID Pengguna" /> <label for="floatingInput">ID Pengguna</label></div>
                                <div class="form-floating message" id="description"><input type="text" class="form-control" id="client-description" placeholder="Masukkan deskripsi" /> <label for="floatingPassword">Deskripsi</label></div>
                                <button class="w-100 btn btn-lg btn-primary add-client-btn" id="pengguna" type="button">Tambah Pengguna</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="pills-auth" role="tabpanel" aria-labelledby="pills-auth-tab">
                    <main>
                        <h1 class="h3 mb-3 fw-normal text-center">QR Code Auth</h1>
                        <div class="row row-cols-1 row-cols-md-3 mb-3 text-center client-container">
                            <div class="col-4 col-md client hide">
                                <div class="card mb-4 rounded-3 shadow-sm">
                                    <div class="card-header py-3"><h4 class="my-0 fw-normal title"></h4></div>
                                    <div class="card-body">
                                        <img src="" alt="QR Code" id="qrcode" />
                                        <h4 class="card-title pricing-card-title"><small class="text-muted fw-light">Logs :</small></h4>
                                        <ul class="list-unstyled mt-3 mb-4 logs"></ul>
                                        <button type="button" class="w-100 btn btn-lg btn-outline-primary description"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
                <div class="tab-pane fade" id="pills-send" role="tabpanel" aria-labelledby="pills-send-tab">
                    <main class="form-signin">
                        <form>
                            <h1 class="h3 mb-3 fw-normal text-center">Kirim Pesan</h1>
                            <div class="form-floating sender"><input type="text" name="sender" class="form-control" id="sender" placeholder="ID Pengguna" /> <label for="floatingInput">Pengguna</label></div>
                            <div class="form-floating number"><input type="text" name="number" class="form-control" id="number" placeholder="Nomor WhatsApp Tujuan" /> <label for="floatingPassword">Nomor</label></div>
                            <div class="form-floating message"><input type="text" name="message" class="form-control" id="message" placeholder="Tulis pesan anda.." /> <label for="floatingPassword">Pesan</label></div>
                            <button class="w-100 btn btn-lg btn-primary" type="button" onclick="sendMessage()">Send</button>
                        </form>
                    </main>
                </div>
                <div class="tab-pane fade" id="pills-media" role="tabpanel" aria-labelledby="pills-media-tab">
                    <main class="form-signin">
                        <form>
                            <h1 class="h3 mb-3 fw-normal text-center">Kirim Media</h1>
                            <div class="form-floating sender"><input type="text" name="sender" class="form-control" id="sender" placeholder="ID Pengguna" /> <label for="floatingInput">Pengguna</label></div>
                            <div class="form-floating number"><input type="text" name="number" class="form-control" id="number" placeholder="Nomor WhatsApp Tujuan" /> <label for="floatingPassword">Nomor</label></div>
                            <div class="form-floating number"><input type="text" name="caption" class="form-control" id="caption" placeholder="Tulis caption.." /> <label for="floatingPassword">Pesan</label></div>
                            <div class="form-floating message"><input type="text" name="file" class="form-control" id="file" placeholder="Url file atau media.." /> <label for="floatingPassword">Url File/Media</label></div>
                            <button class="w-100 btn btn-lg btn-primary" type="button" onclick="sendMedia()">Send</button>
                        </form>
                    </main>
                </div>
            </div>
            <p class="mt-5 mb-3 text-muted text-center">&copy; Basoro 2020 - 2021</p>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
        <script>
            $(document).ready(function () {
                var socket = io();
                var waapitoken = localStorage.getItem("clientId");
                if (localStorage.getItem("clientId") == "admin") {
                    $(".add-client-btn").click(function () {
                        var clientId = $("#client-id").val();
                        var clientDescription = $("#client-description").val();
                        localStorage.setItem("clientId", clientId);
                        var template = $(".client").first().clone().removeClass("hide").addClass(clientId);
                        template.find(".title").html(clientId);
                        template.find(".description").html(clientDescription);
                        $(".client-container").append(template);
                        socket.emit("create-session", { id: clientId, description: clientDescription });
                    });
                } else {
                    $("#pengguna").html("Auth");
                    $("#description").hide();
                    $("#sender1").removeClass("sender1");
                    $("#sender1").addClass("sender2");
                    $(".add-client-btn").click(function () {
                        var clientId = $("#client-id").val();
                        localStorage.setItem("clientId", clientId);
                    });
                }
                socket.on("init", function (data) {
                    var result = data.filter((x) => x.id === waapitoken);
                    if (waapitoken != "admin") {
                        var data = result;
                    }
                    $(".client-container .client").not(":first").remove();
                    for (var i = 0; i < data.length; i++) {
                        var session = data[i];
                        var clientId = session.id;
                        var clientDescription = session.description;
                        var template = $(".client").first().clone().removeClass("hide").addClass(clientId);
                        template.find(".title").html(clientId);
                        template.find(".description").html(clientDescription);
                        $(".client-container").append(template);
                        if (session.ready) {
                            $(`.client.${session.id} .logs`).append($("<li>").text("Whatsapp is ready!"));
                        } else {
                            $(`.client.${session.id} .logs`).append($("<li>").text("Connecting..."));
                        }
                    }
                });
                socket.on("remove-session", function (id) {
                    $(`.client.${id}`).remove();
                });
                socket.on("message", function (data) {
                    $(`.client.${data.id} .logs`).append($("<li>").text(data.text));
                });
                socket.on("qr", function (data) {
                    $(`.client.${data.id} #qrcode`).attr("src", data.src);
                    $(`.client.${data.id} #qrcode`).show();
                });
                socket.on("ready", function (data) {
                    $(`.client.${data.id} #qrcode`).hide();
                });
                socket.on("authenticated", function (data) {
                    $(`.client.${data.id} #qrcode`).hide();
                });
            });
            var api_hostname = $(location).attr('hostname'); 
            function sendMessage() {
                var xhttp = new XMLHttpRequest();
                var sender = document.getElementById("sender").value;
                var number = document.getElementById("number").value;
                var message = document.getElementById("message").value;
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var data = xhttp.responseText;
                        var jsonResponse = JSON.parse(data);
                        if (jsonResponse["status"] == true) {
                            alert("Sukses mengirim pesan.");
                        } else {
                            alert("Gagal mengirim pesan.");
                        }
                    }
                };
                xhttp.open("POST", "http://" + api_hostname + ":8000/send-message", true);
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp.send("sender=" + sender + "&number=" + number + "&message=" + message);
            }
            function sendMedia() {
                var xhttp = new XMLHttpRequest();
                var sender = document.getElementById("sender").value;
                var number = document.getElementById("number").value;
                var caption = document.getElementById("caption").value;
                var file = document.getElementById("file").value;
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var data = xhttp.responseText;
                        var jsonResponse = JSON.parse(data);
                        if (jsonResponse["status"] == true) {
                            alert("Sukses mengirim media.");
                        } else {
                            alert("Gagal mengirim media.");
                        }
                    }
                };                
                xhttp.open("POST", "http://" + api_hostname + ":8000/send-media", true);
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp.send("sender=" + sender + "&number=" + number + "&caption=" + caption + "&file=" + file);
            }
        </script>
    </body>
</html>
